# MTEGM SMM Portal - Apache Configuration
# MVC Router with Security Headers and Optimizations
# Version: 2.1
# Date: 2025-01-27

# ==========================================
# CORE APACHE MODULES
# ==========================================

<IfModule mod_rewrite.c>
    # Enable URL rewriting
    RewriteEngine On

    # Set the base URL for rewriting (adjust if in subdirectory)
    # RewriteBase /mtegmsmm/wwwroot/

    # ==========================================
    # SECURITY: Block access to sensitive files
    # ==========================================

    # Block access to environment and configuration files
    RewriteRule ^(\.env|\.env\..*|config\.php|database\.php)$ - [F,L]

    # Block access to version control files
    RewriteRule ^(\.git|\.svn|\.hg|\.bzr)/ - [F,L]
    RewriteRule ^(\.gitignore|\.gitattributes|\.svnignore)$ - [F,L]

    # Block access to package manager files
    RewriteRule ^(composer\.(json|lock)|package\.(json|lock)|yarn\.lock|Gemfile(\.lock)?|requirements\.txt|Pipfile(\.lock)?)$ - [F,L]

    # Block access to documentation and build files
    RewriteRule ^(README|CHANGELOG|LICENSE|AUTHORS|INSTALL|TODO|gulpfile\.js|Gruntfile\.js|webpack\.config\.js)(\.(md|txt|rst))?$ - [F,L,NC]

    # Block access to backup and temporary files
    RewriteRule \.(bak|backup|old|orig|original|tmp|temp|cache|log|sql)$ - [F,L]
    RewriteRule ~$ - [F,L]

    # Block access to IDE and editor files
    RewriteRule ^(\.vscode|\.idea|\.phpstorm|\.sublime-.*|\.brackets\.json|\.editorconfig)/ - [F,L]

    # ==========================================
    # STATIC ASSETS: Direct access to resources
    # ==========================================

    # Allow direct access to static asset directories
    RewriteCond %{REQUEST_URI} ^/(assets|css|js|images|img|fonts|uploads|public|static)/
    RewriteRule ^(.*)$ $1 [L]

    # Allow direct access to specific file types
    RewriteCond %{REQUEST_URI} \.(css|js|jpg|jpeg|png|gif|svg|ico|webp|woff|woff2|ttf|eot|pdf|doc|docx|xls|xlsx|zip|rar)$ [NC]
    RewriteRule ^(.*)$ $1 [L]

    # Allow direct access to robots.txt and sitemap
    RewriteCond %{REQUEST_URI} ^/(robots\.txt|sitemap\.xml|favicon\.ico|apple-touch-icon.*\.png)$ [NC]
    RewriteRule ^(.*)$ $1 [L]

    # ==========================================
    # FILE/DIRECTORY CHECK
    # ==========================================

    # If the requested file exists, serve it directly
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]

    # If the requested directory exists, serve it directly
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # ==========================================
    # MVC ROUTING: Route all requests to index.php
    # ==========================================

    # Remove trailing slash except for directories
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [R=301,L]

    # Route all other requests through index.php with url parameter
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ index.php?url=$1 [QSA,L]
</IfModule>

# ==========================================
# SECURITY HEADERS
# ==========================================

<IfModule mod_headers.c>
    # Prevent clickjacking attacks
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"

    # Control referrer information
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy (adjust as needed)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://code.jquery.com https://www.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; frame-src https://www.google.com https://www.recaptcha.net; connect-src 'self'; object-src 'none';"

    # Permissions Policy (formerly Feature Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()"

    # HSTS (HTTP Strict Transport Security) - only enable in production with HTTPS
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Remove server information
    Header always unset X-Powered-By
    Header always unset Server

    # Prevent content type sniffing for scripts and styles
    <FilesMatch "\.(js|css)$">
        Header always set X-Content-Type-Options "nosniff"
    </FilesMatch>
</IfModule>

# ==========================================
# PERFORMANCE OPTIMIZATION
# ==========================================

<IfModule mod_expires.c>
    ExpiresActive On

    # Default expiration
    ExpiresDefault "access plus 1 week"

    # HTML - no cache for dynamic content
    ExpiresByType text/html "access plus 0 seconds"

    # Images
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/webp "access plus 1 month"

    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"

    # Fonts
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"

    # Other
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"
    ExpiresByType text/xml "access plus 0 seconds"
</IfModule>

# ==========================================
# COMPRESSION
# ==========================================

<IfModule mod_deflate.c>
    # Enable compression for common file types
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    AddOutputFilterByType DEFLATE image/svg+xml

    # Remove browser bugs for really old browsers
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# ==========================================
# FILE ACCESS CONTROL
# ==========================================

# Disable directory browsing
Options -Indexes

# Follow symbolic links
Options +FollowSymLinks

# Disable MultiViews to prevent content negotiation issues
Options -MultiViews

# ==========================================
# CHARACTER ENCODING
# ==========================================

# Set default charset to UTF-8
AddDefaultCharset UTF-8

# Force UTF-8 for certain file types
<IfModule mod_mime.c>
    AddCharset UTF-8 .html .css .js .xml .json .txt
</IfModule>

# ==========================================
# PHP CONFIGURATION (if mod_php is enabled)
# ==========================================

<IfModule mod_php7.c>
    # Error handling
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log ../logs/php_error.log

    # Security settings
    php_flag expose_php Off
    php_flag allow_url_fopen Off
    php_flag allow_url_include Off

    # Performance settings
    php_value memory_limit 256M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value post_max_size 20M
    php_value upload_max_filesize 10M
    php_value max_file_uploads 20

    # Session settings
    php_flag session.use_cookies On
    php_flag session.use_only_cookies On
    php_flag session.use_strict_mode On
    php_flag session.cookie_httponly On
    php_value session.cookie_samesite Strict
    php_value session.gc_maxlifetime 3600
</IfModule>

<IfModule mod_php8.c>
    # Error handling
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log ../logs/php_error.log

    # Security settings
    php_flag expose_php Off
    php_flag allow_url_fopen Off
    php_flag allow_url_include Off

    # Performance settings
    php_value memory_limit 256M
    php_value max_execution_time 300
    php_value max_input_time 300
    php_value post_max_size 20M
    php_value upload_max_filesize 10M
    php_value max_file_uploads 20

    # Session settings
    php_flag session.use_cookies On
    php_flag session.use_only_cookies On
    php_flag session.use_strict_mode On
    php_flag session.cookie_httponly On
    php_value session.cookie_samesite Strict
    php_value session.gc_maxlifetime 3600
</IfModule>

# ==========================================
# ERROR PAGES (Optional - create these files)
# ==========================================

# ErrorDocument 400 /error/400.html
# ErrorDocument 401 /error/401.html
# ErrorDocument 403 /error/403.html
# ErrorDocument 404 /error/404.html
# ErrorDocument 500 /error/500.html
# ErrorDocument 503 /error/503.html

# ==========================================
# ADDITIONAL SECURITY RULES
# ==========================================

# Block access to .htaccess file itself
<Files ".htaccess">
    Order Allow,Deny
    Deny from all
</Files>

# Block access to PHP files in uploads directory (if exists)
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} ^/uploads/ [NC]
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule \.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$ - [F,L]
</IfModule>

# Prevent script execution in uploads directory
<Directory "../uploads">
    <FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
        Order Deny,Allow
        Deny from all
    </FilesMatch>
</Directory>

# ==========================================
# CORS Headers (if needed for API access)
# ==========================================

# <IfModule mod_headers.c>
#     Header set Access-Control-Allow-Origin "*"
#     Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
#     Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
# </IfModule>

# End of .htaccess configuration